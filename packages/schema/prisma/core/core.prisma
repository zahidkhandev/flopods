// /prisma/schemas/core.prisma

// ==========================================
// CORE SCHEMA - MINIMAL WITH USAGE TRACKING
// ==========================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?
  hash      String?  @db.VarChar(255)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  accounts                 Account[]
  workspaces               WorkspaceUser[]
  refreshTokens            RefreshToken[]
  notifications            Notification[]
  flowCollaborations       FlowCollaborator[]
  sentWorkspaceInvites     WorkspaceInvitation[] @relation("InvitedBy")
  receivedWorkspaceInvites WorkspaceInvitation[] @relation("InvitedUser")
  sentFlowInvites          FlowInvitation[]      @relation("FlowInvitedBy")
  receivedFlowInvites      FlowInvitation[]      @relation("FlowInvitedUser")
  createdApiKeys           ProviderAPIKey[]

  @@index([email])
  @@schema("core")
}

model RefreshToken {
  id         String   @id @default(cuid())
  token      String   @unique
  deviceName String   @db.VarChar(255)
  userId     String
  expiresAt  DateTime @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceName])
  @@index([userId, expiresAt])
  @@index([token, expiresAt])
  @@schema("core")
}

model Account {
  id                String       @id @default(cuid())
  userId            String
  provider          AuthProvider
  providerAccountId String
  accessToken       String?      @db.Text
  refreshToken      String?      @db.Text
  expiresAt         DateTime?    @db.Timestamptz(6)
  createdAt         DateTime     @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@schema("core")
}

model Workspace {
  id        String        @id @default(cuid())
  name      String        @db.VarChar(255)
  type      WorkspaceType @default(PERSONAL)
  createdAt DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt DateTime      @updatedAt @db.Timestamptz(6)

  members         WorkspaceUser[]
  spaces          Space[]
  flows           Flow[]
  documents       Document[]
  documentFolders DocumentFolder[]
  subscription    Subscription?
  contextModules  ContextModule[]
  shareLinks      ShareLink[]
  apiKeys         ProviderAPIKey[]
  invitations     WorkspaceInvitation[]
  usageMetrics    UsageMetric[]

  @@index([type, createdAt])
  @@schema("core")
}

model WorkspaceUser {
  id          String        @id @default(cuid())
  userId      String
  workspaceId String
  role        WorkspaceRole @default(MEMBER)

  canCreateCanvas  Boolean @default(true)
  canDeleteCanvas  Boolean @default(false)
  canManageBilling Boolean @default(false)
  canInviteMembers Boolean @default(false)
  canManageMembers Boolean @default(false)
  canManageApiKeys Boolean @default(false)

  joinedAt  DateTime @default(now()) @db.Timestamptz(6)
  invitedBy String?

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([workspaceId, role])
  @@index([userId])
  @@schema("core")
}

model WorkspaceInvitation {
  id          String        @id @default(cuid())
  workspaceId String
  email       String        @db.VarChar(255)
  role        WorkspaceRole @default(MEMBER)
  permissions Json?

  invitedBy     String
  invitedUserId String?

  token  String           @unique @db.VarChar(255)
  status InvitationStatus @default(PENDING)

  createdAt  DateTime  @default(now()) @db.Timestamptz(6)
  expiresAt  DateTime  @db.Timestamptz(6)
  acceptedAt DateTime? @db.Timestamptz(6)

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  inviter     User      @relation("InvitedBy", fields: [invitedBy], references: [id], onDelete: Cascade)
  invitedUser User?     @relation("InvitedUser", fields: [invitedUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, status])
  @@index([email, status])
  @@index([token, expiresAt])
  @@schema("core")
}

// ==========================================
// API KEY WITH USAGE TRACKING
// ==========================================

model ProviderAPIKey {
  id          String      @id @default(cuid())
  workspaceId String
  provider    LLMProvider
  displayName String      @db.VarChar(100)

  // Encrypted storage (format: iv:authTag:encrypted)
  keyHash String @db.VarChar(500)

  // Status
  isActive Boolean @default(true)

  // Usage tracking
  lastUsedAt  DateTime? @db.Timestamptz(6)
  usageCount  Int       @default(0)
  totalTokens BigInt    @default(0)
  totalCost   Decimal   @default(0) @db.Decimal(12, 6)

  // Error tracking
  lastErrorAt DateTime? @db.Timestamptz(6)

  // Timestamps
  createdById String
  createdAt   DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  workspace     Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy     User           @relation(fields: [createdById], references: [id], onDelete: Restrict)
  usageMetrics  UsageMetric[]
  podExecutions PodExecution[]
  podUsageLogs  PodUsageLog[]

  @@unique([workspaceId, provider, displayName])
  @@index([workspaceId, isActive])
  @@schema("core")
}

// ==========================================
// USAGE METRICS - DAILY BREAKDOWN
// ==========================================

model UsageMetric {
  id          String   @id @default(cuid())
  workspaceId String
  keyId       String
  date        DateTime @db.Date

  // Request counts
  requestCount Int @default(0)
  successCount Int @default(0)
  errorCount   Int @default(0)

  // Token usage
  promptTokens     BigInt @default(0)
  completionTokens BigInt @default(0)
  totalTokens      BigInt @default(0)

  // Cost tracking
  estimatedCost Decimal @default(0) @db.Decimal(12, 6)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  workspace Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  apiKey    ProviderAPIKey @relation(fields: [keyId], references: [id], onDelete: Cascade)

  @@unique([keyId, date])
  @@index([workspaceId, date])
  @@index([keyId, date])
  @@schema("core")
}

model ShareLink {
  id          String             @id @default(cuid())
  publicToken String             @unique @default(cuid())
  assetType   ShareableAssetType
  assetId     String
  workspaceId String
  createdBy   String

  accessLevel ShareAccessLevel @default(VIEW_ONLY)
  password    String?          @db.VarChar(255)

  viewCount    Int       @default(0)
  lastViewedAt DateTime? @db.Timestamptz(6)

  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  expiresAt DateTime? @db.Timestamptz(6)

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([assetType, assetId])
  @@index([publicToken, expiresAt])
  @@index([workspaceId, assetType])
  @@index([createdBy, createdAt])
  @@schema("core")
}

model Notification {
  id     String           @id @default(cuid())
  userId String
  type   NotificationType
  title  String           @db.VarChar(255)
  body   String           @db.Text

  // Reference to related entity
  entityType String? @db.VarChar(50)
  entityId   String?

  // Metadata (invitation IDs, workspace IDs, etc.)
  metadata Json?

  isRead    Boolean   @default(false)
  readAt    DateTime? @db.Timestamptz(6)
  actionUrl String?   @db.VarChar(500)

  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  expiresAt DateTime? @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@index([userId, type, isRead])
  @@schema("core")
}

// ==========================================
// ENUMS
// ==========================================

enum AuthProvider {
  GOOGLE
  GITHUB
  EMAIL

  @@schema("core")
}

enum NotificationType {
  WORKSPACE_INVITATION
  WORKSPACE_MEMBER_JOINED
  WORKSPACE_MEMBER_LEFT
  WORKSPACE_ROLE_CHANGED
  FLOW_INVITATION
  FLOW_SHARED
  MENTION
  COMMENT
  SYSTEM

  @@schema("core")
}

enum WorkspaceType {
  PERSONAL
  TEAM

  @@schema("core")
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER

  @@schema("core")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  REVOKED

  @@schema("core")
}

enum ShareAccessLevel {
  VIEW_ONLY
  COMMENT
  EDIT

  @@schema("core")
}

enum LLMProvider {
  OPENAI
  ANTHROPIC
  GOOGLE_GEMINI
  PERPLEXITY
  MISTRAL
  COHERE
  GROQ
  XAI
  DEEPSEEK
  CUSTOM

  @@schema("core")
}

enum ShareableAssetType {
  FLOW
  CONTEXT_MODULE

  @@schema("core")
}
