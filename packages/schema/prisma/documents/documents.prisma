// prisma/schemas/documents.schema.prisma

// ==========================================
// DOCUMENTS SCHEMA - WITH UNIFIED API LOGGING
// ==========================================

model DocumentFolder {
  id          String @id @default(cuid())
  workspaceId String
  name        String @db.VarChar(255)

  parentId String?
  parent   DocumentFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children DocumentFolder[] @relation("FolderHierarchy")

  icon  String? @db.VarChar(50)
  color String? @db.VarChar(7)

  sortOrder Int @default(0)

  createdBy String
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  workspace Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  documents Document[]

  @@unique([workspaceId, parentId, name])
  @@index([workspaceId, parentId, sortOrder])
  @@index([parentId, sortOrder])
  @@schema("documents")
}

model Document {
  id          String  @id @default(cuid())
  workspaceId String
  folderId    String?
  name        String  @db.VarChar(255)

  sourceType DocumentSourceType @default(INTERNAL)

  storageKey String? @unique @db.VarChar(512)
  s3Bucket   String? @db.VarChar(255)

  externalUrl      String? @db.VarChar(2048)
  externalProvider String? @db.VarChar(50)
  externalFileId   String? @db.VarChar(512)

  fileType    String         @db.VarChar(100)
  mimeType    String?        @db.VarChar(255)
  sizeInBytes BigInt?
  status      DocumentStatus @default(UPLOADING)
  uploadedBy  String?

  metadata Json?

  dynamoPartitionKey String @db.VarChar(255)
  dynamoSortKey      String @db.VarChar(255)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  workspace             Workspace                  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  folder                DocumentFolder?            @relation(fields: [folderId], references: [id], onDelete: SetNull)
  embeddings            Embedding[]
  pods                  Pod[]
  processingCostRecords DocumentProcessingCost[]
  visionAnalyses        DocumentVisionAnalysis[]
  visionSnapshots       VisionExtractionSnapshot[]
  visionMetadata        VisionMetadata?
  apiLogs               DocumentAPILog[]

  @@unique([dynamoPartitionKey, dynamoSortKey])
  @@index([workspaceId, folderId, status, createdAt(sort: Desc)])
  @@index([workspaceId, status, createdAt(sort: Desc)])
  @@index([workspaceId, sourceType, createdAt(sort: Desc)])
  @@index([folderId, createdAt(sort: Desc)])
  @@index([storageKey])
  @@index([status, updatedAt])
  @@index([fileType, workspaceId])
  @@index([externalProvider, externalFileId])
  @@unique([dynamoPartitionKey, dynamoSortKey])
  @@schema("documents")
}

model Embedding {
  id         String @id @default(cuid())
  documentId String
  model      String @db.VarChar(100)
  chunkIndex Int
  chunkText  String @db.Text

  vector Unsupported("vector(768)")?

  s3VectorBucket  String @db.VarChar(255)
  s3VectorKey     String @db.VarChar(512)
  vectorDimension Int    @default(768)

  metadata Json?

  createdAt DateTime @default(now()) @db.Timestamptz(6)

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, chunkIndex])
  @@unique([s3VectorBucket, s3VectorKey])
  @@index([documentId, createdAt(sort: Desc)])
  @@index([model, createdAt(sort: Desc)])
  @@index([s3VectorBucket])
  @@index([vectorDimension])
  @@schema("documents")
}

model DocumentProcessingCost {
  id             String @id @default(cuid())
  documentId     String
  workspaceId    String
  subscriptionId String

  processingType DocumentProcessingType

  creditsConsumed Int @default(0)

  extractionCost Decimal @default(0) @db.Decimal(12, 8)
  embeddingCost  Decimal @default(0) @db.Decimal(12, 8)
  visionCost     Decimal @default(0) @db.Decimal(12, 8)
  totalCostInUsd Decimal @db.Decimal(12, 8)

  chunkCount       Int?
  embeddingModel   String? @db.VarChar(100)
  processingTimeMs Int?
  tokensProcessed  Int     @default(0)
  visionTokens     Int     @default(0)

  processedAt DateTime @default(now()) @db.Timestamptz(6)

  document     Document     @relation(fields: [documentId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([documentId, processedAt(sort: Desc)])
  @@index([workspaceId, processedAt(sort: Desc)])
  @@index([subscriptionId, processedAt(sort: Desc)])
  @@index([processingType, processedAt(sort: Desc)])
  @@schema("documents")
}

model VisionMetadata {
  id          String @id @default(cuid())
  documentId  String @unique
  workspaceId String

  imageOriginalWidth  Int?
  imageOriginalHeight Int?
  imageColorSpace     String? @db.VarChar(50)
  imageColorDepth     Int?
  imageDPI            Int?

  detectedLanguages     Json?
  handwriting           Boolean @default(false)
  handwritingConfidence Float   @default(0)

  aestheticScore  Float @default(0)
  brightnessScore Float @default(0)
  contrastScore   Float @default(0)

  dominantColors Json?
  colorPalette   Json?

  facesDetected Int   @default(0)
  faceCount     Json?

  textLines     Int   @default(0)
  linesPerImage Json?

  fileSize     BigInt?
  fileFormat   String? @db.VarChar(20)
  fileDuration Int?

  exifData Json?
  metadata Json?

  processingQuality String? @db.VarChar(50)
  qualityIssues     Json?

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@schema("documents")
}

model DocumentVisionAnalysis {
  id          String @id @default(cuid())
  documentId  String
  workspaceId String

  provider     LLMProvider @default(GOOGLE_GEMINI) // Use LLMProvider from core
  modelId      String      @db.VarChar(100)
  modelVersion String?     @db.VarChar(50)

  ocrText       String? @db.Text
  ocrConfidence Float   @default(0)
  ocrLanguages  Json?

  imageCaption      String? @db.Text
  captionConfidence Float   @default(0)
  imageSummary      String? @db.Text
  imageStyle        String? @db.VarChar(100)

  detectedObjects Json?
  objectCount     Int   @default(0)

  detectedText Json?
  textContent  String? @db.Text

  entityRecognition Json?
  sentimentAnalysis Json?

  segmentationMasks Json?
  segmentationCount Int   @default(0)

  sceneType        String? @db.VarChar(100)
  sceneDescription String? @db.Text

  activitiesDetected Json?
  poseEstimation     Json?

  imageQuality String? @db.VarChar(50)
  imageBlur    Boolean @default(false)
  imageNoise   Boolean @default(false)

  dominantColors Json?
  colorCount     Int     @default(0)
  colorHarmony   String? @db.VarChar(50)

  textDetected Boolean @default(false)
  qualityScore Int?
  imageFormat  String? @db.VarChar(50)

  processingTimeMs Int?
  requestId        String? @unique @db.VarChar(255)

  inputTokens   Int     @default(0)
  outputTokens  Int     @default(0)
  totalTokens   Int     @default(0)
  estimatedCost Decimal @db.Decimal(12, 8)

  status       VisionAnalysisStatus @default(PENDING)
  errorMessage String?              @db.Text
  errorCode    String?              @db.VarChar(100)
  retryCount   Int                  @default(0)
  lastRetryAt  DateTime?            @db.Timestamptz(6)
  maxRetries   Int                  @default(3)

  requestPayload  Json?
  responseContent String? @db.Text
  rawResponse     Json?

  metadata    Json?
  annotations Json?

  createdAt  DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(6)
  archivedAt DateTime? @db.Timestamptz(6)

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, provider])
  @@index([workspaceId, provider, status, createdAt(sort: Desc)])
  @@index([documentId, provider])
  @@index([status, createdAt(sort: Desc)])
  @@index([workspaceId, createdAt(sort: Desc)])
  @@index([createdAt])
  @@index([provider, createdAt(sort: Desc)])
  @@schema("documents")
}

model VisionExtractionSnapshot {
  id               String  @id @default(cuid())
  documentId       String
  workspaceId      String
  visionAnalysisId String?

  provider       LLMProvider // Use LLMProvider from core
  modelId        String               @db.VarChar(100)
  extractionType VisionExtractionType
  extractedData  String               @db.Text

  confidence  Float    @default(0)
  version     Int      @default(1)
  extractedAt DateTime

  metadata Json?
  summary  String? @db.VarChar(500)
  rawData  Json?

  processingTimeMs Int?
  tokensUsed       Int  @default(0)

  createdAt  DateTime  @default(now()) @db.Timestamptz(6)
  archivedAt DateTime? @db.Timestamptz(6)

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId, provider, extractionType, extractedAt(sort: Desc)])
  @@index([workspaceId, provider, extractedAt(sort: Desc)])
  @@index([extractionType, confidence])
  @@index([documentId, version])
  @@index([extractedAt])
  @@index([provider, extractionType])
  @@schema("documents")
}

// UNIFIED API LOG FOR ALL OPERATIONS
model DocumentAPILog {
  id          String  @id @default(cuid())
  workspaceId String
  documentId  String?

  // Unified provider & request type from core
  provider    LLMProvider
  modelId     String         @db.VarChar(100)
  requestType APIRequestType

  // Token tracking
  inputTokens  Int @default(0)
  outputTokens Int @default(0)
  totalTokens  Int @default(0)

  // Cost & success tracking
  statusCode    Int
  success       Boolean  @default(false)
  estimatedCost Decimal  @db.Decimal(12, 8)
  actualCost    Decimal? @db.Decimal(12, 8)

  // Error tracking
  errorMessage String? @db.Text
  errorCode    String? @db.VarChar(100)

  // Performance
  requestDurationMs Int?

  // Extensible metadata (profit, credits, multiplier, etc)
  metadata Json?

  processedAt DateTime  @default(now()) @db.Timestamptz(6)
  archivedAt  DateTime? @db.Timestamptz(6)

  document Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@index([workspaceId, provider, processedAt(sort: Desc)])
  @@index([documentId, provider, processedAt(sort: Desc)])
  @@index([modelId, processedAt(sort: Desc)])
  @@index([statusCode, processedAt(sort: Desc)])
  @@index([success, provider, processedAt(sort: Desc)])
  @@index([requestType, processedAt(sort: Desc)])
  @@index([processedAt])
  @@schema("documents")
}

// ==========================================
// ENUMS
// ==========================================

enum DocumentStatus {
  UPLOADING
  PROCESSING
  READY
  ERROR
  ARCHIVED

  @@schema("documents")
}

enum DocumentSourceType {
  INTERNAL
  GOOGLE_DRIVE
  YOUTUBE
  VIMEO
  LOOM
  URL

  @@schema("documents")
}

enum DocumentProcessingType {
  PDF_TEXT_EXTRACTION
  IMAGE_OCR
  VIDEO_TRANSCRIPT
  AUDIO_TRANSCRIPT
  DOCUMENT_EMBEDDING
  URL_SCRAPING
  VISION_EXTRACTION

  @@schema("documents")
}

enum VisionAnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  PARTIAL_COMPLETION
  ERROR
  ARCHIVED

  @@schema("documents")
}

enum VisionExtractionType {
  OCR_TEXT
  IMAGE_CAPTION
  IMAGE_SUMMARY
  OBJECT_DETECTION
  SEGMENTATION_MASK
  COLOR_ANALYSIS
  ENTITY_RECOGNITION
  SENTIMENT_ANALYSIS
  SCENE_DETECTION
  ACTIVITY_DETECTION
  POSE_ESTIMATION
  FACE_DETECTION
  TEXT_EXTRACTION
  HANDWRITING_DETECTION

  @@schema("documents")
}

// ADD THIS NEW ENUM TO CORE
// Add to prisma/schemas/core.prisma after LLMProvider enum

enum APIRequestType {
  TEXT_GENERATION // LLM prompts (OpenAI, Claude, Gemini)
  VECTOR_SEARCH // Embedding queries
  DOCUMENT_EMBEDDING // Creating embeddings
  IMAGE_ANALYSIS // Vision analysis
  MULTIMODAL // Any multimodal operation

  @@schema("core")
}
