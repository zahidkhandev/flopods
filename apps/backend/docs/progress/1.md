# Actopod Backend - Project Summary & Context

## Project Overview

**Platform:** AI Workflow Canvas - Multi-LLM Node-Based Platform  
**Tech Stack:** NestJS, Prisma, PostgreSQL, TypeScript, AWS (SES, S3), DynamoDB  
**Architecture:** Monorepo (Turborepo) with separate backend/frontend packages  
**Database Schemas:** Core, Billing, Canvas, Documents (Multi-schema PostgreSQL)

---

## ‚úÖ What We've Completed

### 1. **Complete Authentication System (100% Done)**

**Features Implemented:**

- ‚úÖ Email/Password authentication with bcrypt hashing
- ‚úÖ Email verification with token-based system (24hr expiry)
- ‚úÖ Resend verification email (1-minute rate limit)
- ‚úÖ Password reset flow (1hr token expiry)
- ‚úÖ Magic link passwordless authentication (15min expiry)
- ‚úÖ Google OAuth integration
- ‚úÖ GitHub OAuth integration
- ‚úÖ JWT-based access tokens (15min expiry)
- ‚úÖ JWT refresh tokens (7 days expiry)
- ‚úÖ Device tracking with User-Agent parsing
- ‚úÖ Multi-device session management
- ‚úÖ Logout from single device
- ‚úÖ Logout from all devices
- ‚úÖ Auto-creation of personal workspace on registration
- ‚úÖ Email verification is OPTIONAL (users can login without verifying)

**Technical Implementation:**

- Token-based authentication with refresh token rotation
- Device identification using database CUID (stable across refreshes)
- User-Agent parsing for device names (e.g., "Windows ‚Äì Chrome")
- Secure password hashing with bcrypt (10 rounds)
- SHA-256 hashing for verification/reset tokens
- Email templates for verification, password reset, magic link, and welcome emails
- Rate limiting on magic links (3 attempts per hour)

**Database Models:**

```typescript
-User(email, name, image, hash, timestamps) -
  Account(userId, provider, providerAccountId, tokens) -
  RefreshToken(userId, deviceId, token, expiresAt);
```

**Auth Providers:**

- EMAIL (email/password)
- GOOGLE (OAuth)
- GITHUB (OAuth)

---

### 2. **Global Infrastructure Setup**

**Response Interceptor:**

- Standardized API response format:
  ```json
  {
    "statusCode": 200,
    "message": "Success",
    "data": {...},
    "errors": [],
    "timestamp": "2025-10-12T17:30:00.000Z"
  }
  ```
- Automatic pagination support
- Response sanitization (removes `hash`, `password` fields)
- Handles OAuth redirects without wrapping

**Exception Filter:**

- Global error handling
- Consistent error response format
- Prevents "headers already sent" errors
- Detailed logging for debugging

**Validation:**

- Global ValidationPipe with class-validator
- DTOs for all endpoints
- Automatic whitelist and transformation
- Custom error messages

**Swagger Documentation:**

- Auto-generated API docs at `/api/v1/docs`
- Bearer token authentication support
- Endpoint descriptions and examples
- Response schema definitions

---

### 3. **Environment Configuration**

**`.env` Structure:**

```env
# Database
DATABASE_URL="postgresql://..."

# Backend
BACKEND_PORT=8000
FRONTEND_URL="http://localhost:5173"

# JWT
JWT_ACCESS_TOKEN_SECRET=...
JWT_REFRESH_TOKEN_SECRET=...
JWT_ACCESS_TOKEN_EXPIRATION=15m
JWT_REFRESH_TOKEN_EXPIRATION=7d

# OAuth
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
GOOGLE_CALLBACK_URL=http://localhost:8000/api/v1/auth/google/callback

GITHUB_CLIENT_ID=...
GITHUB_CLIENT_SECRET=...
GITHUB_CALLBACK_URL=http://localhost:8000/api/v1/auth/github/callback

# AWS SES
AWS_REGION=us-east-1
AWS_SES_ACCESS_KEY_ID=...
AWS_SES_SECRET_ACCESS_KEY=...
AWS_SES_NO_REPLY_EMAIL=noreply@actopod.dev
```

---

### 4. **Prisma Schema Design**

**Core Schema (Complete):**

- User, Account, RefreshToken
- Workspace, WorkspaceUser, WorkspaceInvitation
- ProviderAPIKey (LLM provider keys)
- ShareLink (public sharing)

**Billing Schema (Designed):**

- Subscription (tiers: HOBBYIST, PRO, TEAM)
- CreditPurchase, CreditUsageLog
- ModelPricingTier (LLM pricing)

**Canvas Schema (Designed):**

- Canvas, ActionPod, Edge
- CanvasCollaborator, CanvasInvitation
- CanvasSession (real-time collaboration)
- CanvasActivityLog, CanvasComment
- ActionPodExecution, PodUsageLog

**Documents Schema (Designed):**

- Document (S3 storage)
- Embedding (S3 vector storage, NO pgvector)

---

### 5. **API Endpoints (Auth Module)**

**Complete Endpoints:**

```typescript
// Registration & Login
POST / api / v1 / auth / register;
POST / api / v1 / auth / verify - email;
POST / api / v1 / auth / resend - verification;
POST / api / v1 / auth / login;
GET / api / v1 / auth / email - verified - status;

// Password Reset
POST / api / v1 / auth / forgot - password;
POST / api / v1 / auth / reset - password;

// Magic Link
POST / api / v1 / auth / magic - link / send;
POST / api / v1 / auth / magic - link / verify;

// OAuth
GET / api / v1 / auth / google;
GET / api / v1 / auth / google / callback;
GET / api / v1 / auth / github;
GET / api / v1 / auth / github / callback;

// Token Management
POST / api / v1 / auth / refresh;
POST / api / v1 / auth / logout;
POST / api / v1 / auth / logout - all;
GET / api / v1 / auth / me;
```

---

### 6. **Key Design Decisions**

**Authentication:**

- Email verification is optional (better UX)
- Refresh token rotation for security
- Stable device IDs using database CUID
- Device names parsed from User-Agent
- Multiple OAuth providers supported

**Database:**

- Multi-schema approach (core, billing, canvas, documents)
- S3 for vectors (no pgvector dependency)
- DynamoDB for pod content (hot data)
- PostgreSQL for metadata (cold data)

**Architecture:**

- Monorepo with Turborepo
- Shared schema package (@actopod/schema)
- Versioned API (v1)
- Modular structure (easy to scale)

---

### 7. **Development Guidelines Document**

Created comprehensive guidelines covering:

- Module creation workflow (NestJS CLI commands)
- Database migration process
- Authentication/authorization patterns
- API response format standards
- Error handling conventions
- Testing guidelines
- Complete code generation checklist

---

## üìã Current State

**Project Structure:**

```
actopod/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ backend/              # NestJS API (‚úÖ Auth complete)
‚îÇ   ‚îî‚îÄ‚îÄ frontend/             # React (not started)
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îî‚îÄ‚îÄ schema/               # Prisma schema (‚úÖ Designed)
‚îú‚îÄ‚îÄ .env                      # Environment variables
‚îî‚îÄ‚îÄ turbo.json               # Turborepo config
```

**Modules Status:**

- ‚úÖ **Auth Module:** 100% complete with all features
- ‚è≥ **Workspace Module:** Next to build
- ‚è≥ **Canvas Module:** Schema designed
- ‚è≥ **Documents Module:** Schema designed
- ‚è≥ **Billing Module:** Schema designed

---

## üéØ Next Steps (Recommended Order)

1. **Workspace Module** (Foundation for everything)
   - Workspace CRUD
   - Member management
   - Invitations
   - API key management (LLM providers)

2. **Canvas Module** (Core product)
   - Canvas CRUD
   - Collaborators
   - Comments
   - Activity log

3. **Action Pods & Edges** (Canvas functionality)
   - Pod CRUD
   - Edge connections
   - Execution engine
   - DynamoDB integration

4. **Documents Module** (File handling)
   - S3 upload/download
   - Embeddings generation
   - Vector search

5. **Billing Module** (Monetization)
   - Subscription management
   - Credit system
   - Stripe integration

6. **Real-Time Module** (Collaboration)
   - WebSocket server
   - Presence system
   - Live updates

---

## üîë Key Technical Details

**Authentication Flow:**

1. User registers ‚Üí Email sent with verification token
2. User can login immediately (verification optional)
3. Login generates access token (15min) + refresh token (7 days)
4. Refresh token stored in database with device info
5. On refresh ‚Üí old token deleted, new tokens generated
6. Device ID stays stable across refreshes (database CUID)

**OAuth Flow:**

1. User clicks "Sign in with Google/GitHub"
2. Redirected to OAuth provider
3. Provider redirects back to callback
4. Backend validates, creates/updates user
5. Returns tokens via frontend redirect with query params

**Device Tracking:**

- Device ID: Database CUID (e.g., `cmgnzach4000bkj44pb3sy84v`)
- Device Name: User-Agent parsed (e.g., `Windows ‚Äì Chrome`)
- One refresh token per user+device combination
- UPDATE instead of DELETE+CREATE keeps ID stable

---

## üìö Important Files

**Backend:**

- `apps/backend/src/main.ts` - Bootstrap, CORS, Swagger
- `apps/backend/src/app.module.ts` - Root module
- `apps/backend/src/v1/auth/` - Complete auth implementation
- `apps/backend/src/common/` - Shared utilities

**Schema:**

- `packages/schema/prisma/schema.prisma` - Database models
- `packages/schema/prisma/migrations/` - Migration history

**Config:**

- `.env` - Environment variables
- `turbo.json` - Build configuration
- `package.json` - Dependencies

---

## üöÄ Running the Project

```bash
# Install dependencies
yarn install

# Start backend (dev mode)
yarn dev

# Access API
http://localhost:8000/api/v1/health

# Access Swagger docs
http://localhost:8000/api/v1/docs

# Database migrations
cd packages/schema
yarn db:migrate

# Prisma Studio
yarn db:studio
```

---

This summary provides complete context for continuing development. The authentication foundation is solid and production-ready. Use the guidelines document when building new modules to maintain consistency.
